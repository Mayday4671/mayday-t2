# UDP协议净荷实体类使用指南

## 概述

UDP协议支持根据不同的帧类型解析对应的净荷实体类。系统会自动根据帧类型（心跳、数据、控制、响应）解析对应的净荷结构。

## 内置净荷类

### 1. HeartbeatPayload（心跳包净荷）

**字节结构：**
```
+--------+--------+--------+--------+--------+
| 设备ID (4字节, 可选)      | 状态(1字节, 可选) |
+--------+--------+--------+--------+--------+
```

**示例：**
```java
// 字节流: 00 00 00 01 00
// 解析结果：
// - 设备ID: 1
// - 状态: 0 (正常)
```

### 2. DataPayload（数据包净荷）

**字节结构：**
```
+--------+--------+--------+--------+--------+--------+
| 数据类型(2字节) | 数据内容(变长)                    |
+--------+--------+--------+--------+--------+--------+
```

**示例：**
```java
// 字节流: 00 01 48 65 6C 6C 6F
// 解析结果：
// - 数据类型: 1 (传感器数据)
// - 数据内容: "Hello"
```

### 3. ControlPayload（控制包净荷）

**字节结构：**
```
+--------+--------+--------+--------+--------+
| 控制命令(2字节) | 命令参数(变长)              |
+--------+--------+--------+--------+--------+
```

**示例：**
```java
// 字节流: 00 01 53 74 61 72 74
// 解析结果：
// - 控制命令: 1 (启动)
// - 命令参数: "Start"
```

### 4. ResponsePayload（响应包净荷）

**字节结构：**
```
+--------+--------+--------+--------+--------+
| 响应码(2字节)   | 响应消息(变长)              |
+--------+--------+--------+--------+--------+
```

**示例：**
```java
// 字节流: 00 00 4F 4B
// 解析结果：
// - 响应码: 0 (成功)
// - 响应消息: "OK"
```

## 自定义净荷类

### 创建自定义净荷类

1. **创建净荷实体类**，使用 `@ProtocolEntity` 注解：

```java
package com.mayday.common.protocol.udp.payload;

import com.mayday.common.protocol.udp.annotation.ProtocolEntity;
import com.mayday.common.protocol.udp.annotation.ProtocolField;
import lombok.Data;

/**
 * 传感器数据净荷
 */
@Data
@ProtocolEntity(name = "传感器数据净荷", description = "传感器数据净荷", version = 1)
public class SensorDataPayload {
    
    /**
     * 传感器ID（2字节）
     */
    @ProtocolField(
        name = "传感器ID", 
        description = "传感器ID", 
        byteOffset = 0, 
        byteLength = 2, 
        type = ProtocolField.FieldType.SHORT
    )
    private Integer sensorId;
    
    /**
     * 温度值（2字节，单位：0.1°C）
     */
    @ProtocolField(
        name = "温度值", 
        description = "温度值", 
        byteOffset = 2, 
        byteLength = 2, 
        type = ProtocolField.FieldType.SHORT
    )
    private Integer temperature;
    
    /**
     * 湿度值（2字节，单位：0.1%）
     */
    @ProtocolField(
        name = "湿度值", 
        description = "湿度值", 
        byteOffset = 4, 
        byteLength = 2, 
        type = ProtocolField.FieldType.SHORT
    )
    private Integer humidity;
}
```

2. **修改 PayloadParser**，添加自定义净荷的解析逻辑：

```java
// 在 PayloadParser.parsePayload 方法中添加：
case DATA:
    // 可以根据消息内容判断使用哪个净荷类
    if (isSensorData(payloadBytes)) {
        return parseSensorDataPayload(byteBuf);
    }
    return parseDataPayload(byteBuf);
```

### 字段类型说明

- **BYTE**: 1字节，范围 0-255
- **SHORT**: 2字节，范围 0-65535
- **INT**: 4字节，范围 0-4294967295
- **LONG**: 8字节
- **BYTES**: 变长字节数组，从指定偏移开始到净荷结束的所有字节

### 注意事项

1. **byteOffset**: 字段在净荷中的字节偏移量（从0开始，相对于净荷起始位置）
2. **byteLength**: 字段的字节长度（BYTES类型可以不指定，会自动读取剩余所有字节）
3. **required**: 字段是否必需（默认true，可选字段设置为false）
4. **变长字段**: 使用 `BYTES` 类型且不指定 `byteLength` 时，会读取从该偏移到净荷结束的所有字节

## 完整报文示例

### 心跳包示例

```
完整报文（15字节）：
+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
| 协议头 (10字节)                                                              | 净荷 (5字节)                    |
+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
| 40 00 00 01 00 05 00 00 00 00                                                | 00 00 00 01 00                   |
+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+

协议头解析：
- 协议版本: 1
- 帧类型: HEARTBEAT (0x0)
- 序列号: 1
- 数据长度: 5

净荷解析：
- 设备ID: 1
- 状态: 0 (正常)
```

### 数据包示例

```
完整报文（18字节）：
+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
| 协议头 (10字节)                                                              | 净荷 (8字节)                                    |
+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
| 41 00 00 02 00 08 00 00 00 00                                                | 00 01 48 65 6C 6C 6F                            |
+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+

协议头解析：
- 协议版本: 1
- 帧类型: DATA (0x1)
- 序列号: 2
- 数据长度: 8

净荷解析：
- 数据类型: 1 (传感器数据)
- 数据内容: "Hello"
```

## 前端展示

解析后的净荷字段会自动显示在前端界面上，包括：
- 字段名称
- 字节范围
- 十六进制值
- 十进制值
- 字符串值（如果是可打印字符）
- 字段说明

这样可以让用户直观地理解报文的结构和内容。


